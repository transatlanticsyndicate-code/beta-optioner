/**
 * –°—Ç—Ä–∞–Ω–∏—Ü–∞ "–†–µ–π—Ç–∏–Ω–≥ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç"
 * –ó–ê–ß–ï–ú: –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É –∏ —Ä–µ–π—Ç–∏–Ω–≥ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç
 * –ó–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç: —Ä–∞–∑–¥–µ–ª –ê–Ω–∞–ª–∏—Ç–∏–∫–∞, –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
 */

import React, { useState, useEffect } from 'react';
import { Play, ChevronDown, ChevronUp, Calendar, Clock, TrendingDown, TrendingUp } from 'lucide-react';

const API_BASE_URL = process.env.REACT_APP_API_URL || 'http://localhost:8000';

function CryptoRating() {
  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
  const [snapshots, setSnapshots] = useState([]);
  const [analyses, setAnalyses] = useState([]);
  const [selectedAnalysis, setSelectedAnalysis] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [success, setSuccess] = useState(null);
  
  // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
  useEffect(() => {
    fetchData();
  }, []);
  
  // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
  const fetchData = async () => {
    try {
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–Ω–∏–º–∫–∏
      const snapshotsRes = await fetch(`${API_BASE_URL}/api/crypto-rating/snapshots`);
      if (snapshotsRes.ok) {
        const snapshotsData = await snapshotsRes.json();
        setSnapshots(snapshotsData);
      }
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–Ω–∞–ª–∏–∑—ã
      const analysesRes = await fetch(`${API_BASE_URL}/api/crypto-rating/analyses`);
      if (analysesRes.ok) {
        const analysesData = await analysesRes.json();
        setAnalyses(analysesData);
      }
    } catch (err) {
      console.error('Error fetching data:', err);
    }
  };
  
  // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–Ω–∏–º–∫–∞
  const handleCreateSnapshot = async () => {
    setLoading(true);
    setError(null);
    setSuccess(null);
    
    try {
      const response = await fetch(`${API_BASE_URL}/api/crypto-rating/create-snapshot`, {
        method: 'POST'
      });
      
      if (!response.ok) throw new Error('Failed to create snapshot');
      
      const data = await response.json();
      
      if (data.analysis_created) {
        setSuccess(`–°–Ω–∏–º–æ–∫ —Å–æ–∑–¥–∞–Ω! –ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω: ${data.crypto_count} –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ.`);
      } else {
        setSuccess(`–ü–µ—Ä–≤—ã–π —Å–Ω–∏–º–æ–∫ —Å–æ–∑–¥–∞–Ω! ${data.crypto_count} –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ. –°–æ–∑–¥–∞–π—Ç–µ –µ—â–µ –æ–¥–∏–Ω —Å–Ω–∏–º–æ–∫ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.`);
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
      await fetchData();
      
    } catch (err) {
      setError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–Ω–∏–º–∫–∞: ' + err.message);
    } finally {
      setLoading(false);
    }
  };
  
  // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π –∞–Ω–∞–ª–∏–∑–∞
  const handleAnalysisClick = async (analysisId) => {
    if (selectedAnalysis?.id === analysisId) {
      setSelectedAnalysis(null);
      return;
    }
    
    try {
      const response = await fetch(`${API_BASE_URL}/api/crypto-rating/analyses/${analysisId}`);
      if (!response.ok) throw new Error('Failed to fetch analysis details');
      const data = await response.json();
      setSelectedAnalysis(data);
    } catch (err) {
      console.error('Error fetching analysis details:', err);
      setError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–µ—Ç–∞–ª–µ–π –∞–Ω–∞–ª–∏–∑–∞');
    }
  };
  
  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
  const formatDate = (dateString) => {
    const date = new Date(dateString);
    return date.toLocaleString('ru-RU', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  };
  
  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–Ω—è –Ω–µ–¥–µ–ª–∏
  const formatDayOfWeek = (day) => {
    const days = {
      'monday': '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫',
      'tuesday': '–í—Ç–æ—Ä–Ω–∏–∫',
      'wednesday': '–°—Ä–µ–¥–∞',
      'thursday': '–ß–µ—Ç–≤–µ—Ä–≥',
      'friday': '–ü—è—Ç–Ω–∏—Ü–∞',
      'saturday': '–°—É–±–±–æ—Ç–∞',
      'sunday': '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'
    };
    return days[day] || day;
  };
  
  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞
  const formatInterval = (value, unit) => {
    const units = {
      'hours': value === 1 ? '—á–∞—Å' : value < 5 ? '—á–∞—Å–∞' : '—á–∞—Å–æ–≤',
      'days': value === 1 ? '–¥–µ–Ω—å' : value < 5 ? '–¥–Ω—è' : '–¥–Ω–µ–π'
    };
    return `${value} ${units[unit]}`;
  };

  return (
    <div className="w-full">
      {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */}
      <div className="mb-6">
        <h1 className="text-3xl font-bold text-foreground mb-2">
          –†–µ–π—Ç–∏–Ω–≥ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç
        </h1>
        <p className="text-muted-foreground">
          –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¢–æ–ø 400 –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç - –≤—ã–±—ã–≤—à–∏–µ/–Ω–æ–≤—ã–µ
        </p>
      </div>

      {/* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */}
      {error && (
        <div className="mb-4 p-4 bg-red-500/10 border border-red-500/20 rounded-lg text-red-500">
          {error}
        </div>
      )}
      
      {success && (
        <div className="mb-4 p-4 bg-green-500/10 border border-green-500/20 rounded-lg text-green-500">
          {success}
        </div>
      )}

      {/* –ü–∞–Ω–µ–ª—å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ */}
      <div className="bg-card rounded-lg border border-border p-6 mb-6">
        <h2 className="text-lg font-semibold text-foreground mb-4">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</h2>
        <p className="text-sm text-muted-foreground mb-4">
          –ó–∞–¥–∞–π—Ç–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ç–æ–ø-400 –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç
        </p>
        
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          {/* –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏ */}
          <div>
            <label className="block text-sm font-medium text-foreground mb-2">
              –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏
            </label>
            <select
              value={dayOfWeek}
              onChange={(e) => setDayOfWeek(e.target.value)}
              className="w-full px-3 py-2 bg-background border border-border rounded-md text-foreground focus:outline-none focus:ring-2 focus:ring-primary"
            >
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å</option>
              <option value="monday">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</option>
              <option value="tuesday">–í—Ç–æ—Ä–Ω–∏–∫</option>
              <option value="wednesday">–°—Ä–µ–¥–∞</option>
              <option value="thursday">–ß–µ—Ç–≤–µ—Ä–≥</option>
              <option value="friday">–ü—è—Ç–Ω–∏—Ü–∞</option>
              <option value="saturday">–°—É–±–±–æ—Ç–∞</option>
              <option value="sunday">–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ</option>
            </select>
          </div>

          {/* –í—Ä–µ–º—è */}
          <div>
            <label className="block text-sm font-medium text-foreground mb-2">
              –í—Ä–µ–º—è (New York)
            </label>
            <input
              type="time"
              value={time}
              onChange={(e) => setTime(e.target.value)}
              className="w-full px-3 py-2 bg-background border border-border rounded-md text-foreground focus:outline-none focus:ring-2 focus:ring-primary"
            />
          </div>

          {/* –ò–Ω—Ç–µ—Ä–≤–∞–ª */}
          <div>
            <label className="block text-sm font-medium text-foreground mb-2">
              –ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É —Å–Ω–∏–º–∫–∞–º–∏
            </label>
            <div className="flex gap-2">
              <input
                type="number"
                value={intervalValue}
                onChange={(e) => setIntervalValue(e.target.value)}
                placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ"
                min="1"
                className="flex-1 px-3 py-2 bg-background border border-border rounded-md text-foreground focus:outline-none focus:ring-2 focus:ring-primary"
              />
              <select
                value={intervalUnit}
                onChange={(e) => setIntervalUnit(e.target.value)}
                className="w-28 px-3 py-2 bg-background border border-border rounded-md text-foreground focus:outline-none focus:ring-2 focus:ring-primary"
              >
                <option value="hours">–ß–∞—Å–æ–≤</option>
                <option value="days">–î–Ω–µ–π</option>
              </select>
            </div>
          </div>
        </div>
        
        <div className="flex items-start gap-4">
          <button
            onClick={() => {
              console.log('üîò –ö–Ω–æ–ø–∫–∞ –Ω–∞–∂–∞—Ç–∞!');
              handleStartMonitoring();
            }}
            disabled={loading}
            className="flex items-center gap-2 px-6 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <Play className="h-4 w-4" />
            {loading ? '–ó–∞–ø—É—Å–∫...' : '–ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥'}
          </button>
          
          {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫—Ç–∏–≤–Ω–æ–π –∑–∞–¥–∞—á–µ */}
          {activeTask && (
            <div className="flex-1 p-3 bg-blue-500/10 border border-blue-500/20 rounded-md">
              <div className="flex items-start gap-2">
                <Clock className="h-5 w-5 text-blue-500 mt-0.5 flex-shrink-0" />
                <div className="text-sm flex-1">
                  <p className="text-foreground font-medium mb-1">
                    –ê–∫—Ç–∏–≤–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
                  </p>
                  <p className="text-muted-foreground">
                    <span className="font-semibold">{formatDayOfWeek(activeTask.day_of_week)}</span> –≤ <span className="font-semibold">{activeTask.time}</span> (New York), 
                    –∏–Ω—Ç–µ—Ä–≤–∞–ª: <span className="font-semibold">{formatInterval(activeTask.interval_value, activeTask.interval_unit)}</span>
                  </p>
                  {activeTask.next_run_at && (
                    <p className="text-muted-foreground text-xs mt-1">
                      –°–ª–µ–¥—É—é—â–∏–π —Å–Ω–∏–º–æ–∫: {formatDate(activeTask.next_run_at)}
                    </p>
                  )}
                  
                  {/* –°—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è */}
                  <div className="mt-3 pt-3 border-t border-blue-500/20">
                    <p className="text-xs font-medium text-foreground mb-2">–°—Ç–∞—Ç—É—Å –æ–ø–µ—Ä–∞—Ü–∏–π:</p>
                    <div className="space-y-1.5">
                      {activeTask.last_run_at ? (
                        <>
                          <div className="flex items-center gap-2 text-xs">
                            <div className="w-2 h-2 rounded-full bg-green-500"></div>
                            <span className="text-muted-foreground">
                              –ü–µ—Ä–≤—ã–π —Å–Ω–∏–º–æ–∫ —Å–æ–∑–¥–∞–Ω: {formatDate(activeTask.last_run_at)}
                            </span>
                          </div>
                          {activeTask.next_run_at && (
                            <div className="flex items-center gap-2 text-xs">
                              <div className="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></div>
                              <span className="text-muted-foreground">
                                –û–∂–∏–¥–∞–µ—Ç—Å—è –≤—Ç–æ—Ä–æ–π —Å–Ω–∏–º–æ–∫: {formatDate(activeTask.next_run_at)}
                              </span>
                            </div>
                          )}
                        </>
                      ) : (
                        <div className="flex items-center gap-2 text-xs">
                          <div className="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></div>
                          <span className="text-muted-foreground">
                            –û–∂–∏–¥–∞–µ—Ç—Å—è –ø–µ—Ä–≤—ã–π —Å–Ω–∏–º–æ–∫: {activeTask.next_run_at ? formatDate(activeTask.next_run_at) : '–ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é'}
                          </span>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      </div>

      {/* –°–ø–∏—Å–æ–∫ –∞–Ω–∞–ª–∏–∑–æ–≤ */}
      <div className="bg-card rounded-lg border border-border p-6">
        <h2 className="text-lg font-semibold text-foreground mb-4">–ò—Å—Ç–æ—Ä–∏—è –∞–Ω–∞–ª–∏–∑–æ–≤</h2>
        
        {analyses.length === 0 ? (
          <div className="text-center text-muted-foreground py-8">
            <p>–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–æ–≤</p>
            <p className="text-sm mt-2">–ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</p>
          </div>
        ) : (
          <div className="space-y-3">
            {analyses.map((analysis) => (
              <div key={analysis.id} className="border border-border rounded-lg overflow-hidden">
                {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∞–Ω–∞–ª–∏–∑–∞ */}
                <button
                  onClick={() => handleAnalysisClick(analysis.id)}
                  className="w-full p-4 flex items-center justify-between hover:bg-accent transition-colors text-left"
                >
                  <div className="flex items-center gap-4">
                    <div className="flex items-center gap-2 text-sm text-muted-foreground">
                      <Calendar className="h-4 w-4" />
                      {formatDate(analysis.created_at)}
                    </div>
                    <div className="flex items-center gap-4">
                      <div className="flex items-center gap-1 text-red-500">
                        <TrendingDown className="h-4 w-4" />
                        <span className="font-semibold">{analysis.dropped_count}</span>
                        <span className="text-xs">–≤—ã–ø–∞–ª–∏</span>
                      </div>
                      <div className="flex items-center gap-1 text-green-500">
                        <TrendingUp className="h-4 w-4" />
                        <span className="font-semibold">{analysis.added_count}</span>
                        <span className="text-xs">–≤–æ—à–ª–∏</span>
                      </div>
                    </div>
                  </div>
                  {selectedAnalysis?.id === analysis.id ? (
                    <ChevronUp className="h-5 w-5 text-muted-foreground" />
                  ) : (
                    <ChevronDown className="h-5 w-5 text-muted-foreground" />
                  )}
                </button>
                
                {/* –î–µ—Ç–∞–ª–∏ –∞–Ω–∞–ª–∏–∑–∞ */}
                {selectedAnalysis?.id === analysis.id && (
                  <div className="p-4 bg-muted/30 border-t border-border">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      {/* –í—ã–ø–∞–≤—à–∏–µ –∏–∑ —Ç–æ–ø–∞ */}
                      <div>
                        <h3 className="font-semibold text-foreground mb-3 flex items-center gap-2">
                          <TrendingDown className="h-5 w-5 text-red-500" />
                          –í—ã–ø–∞–ª–∏ –∏–∑ —Ç–æ–ø-400 ({selectedAnalysis.dropped_cryptos.length})
                        </h3>
                        <div className="space-y-2 max-h-96 overflow-y-auto">
                          {selectedAnalysis.dropped_cryptos.length === 0 ? (
                            <p className="text-sm text-muted-foreground">–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π</p>
                          ) : (
                            selectedAnalysis.dropped_cryptos.map((crypto, index) => (
                              <div key={index} className="flex items-center gap-2 p-2 bg-background rounded text-sm">
                                <span className="font-mono font-semibold text-foreground">{crypto.symbol}</span>
                                <span className="text-muted-foreground">{crypto.name}</span>
                              </div>
                            ))
                          )}
                        </div>
                      </div>
                      
                      {/* –í–æ—à–ª–∏ –≤ —Ç–æ–ø */}
                      <div>
                        <h3 className="font-semibold text-foreground mb-3 flex items-center gap-2">
                          <TrendingUp className="h-5 w-5 text-green-500" />
                          –í–æ—à–ª–∏ –≤ —Ç–æ–ø-400 ({selectedAnalysis.added_cryptos.length})
                        </h3>
                        <div className="space-y-2 max-h-96 overflow-y-auto">
                          {selectedAnalysis.added_cryptos.length === 0 ? (
                            <p className="text-sm text-muted-foreground">–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π</p>
                          ) : (
                            selectedAnalysis.added_cryptos.map((crypto, index) => (
                              <div key={index} className="flex items-center gap-2 p-2 bg-background rounded text-sm">
                                <span className="font-mono font-semibold text-foreground">{crypto.symbol}</span>
                                <span className="text-muted-foreground">{crypto.name}</span>
                              </div>
                            ))
                          )}
                        </div>
                      </div>
                    </div>
                    
                    {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–Ω–∏–º–∫–∞—Ö */}
                    <div className="mt-4 pt-4 border-t border-border text-xs text-muted-foreground">
                      <div className="flex items-center gap-4">
                        <span>–ü–µ—Ä–≤—ã–π —Å–Ω–∏–º–æ–∫: {formatDate(selectedAnalysis.first_snapshot_date)}</span>
                        <span>‚Ä¢</span>
                        <span>–í—Ç–æ—Ä–æ–π —Å–Ω–∏–º–æ–∫: {formatDate(selectedAnalysis.second_snapshot_date)}</span>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}

export default CryptoRating;

# План разработки: Калькулятор опционов с графиком P&L

## 📋 Описание задачи

Создать калькулятор опционов с интерактивным графиком прибыли/убытка (P&L), аналогичный функционалу TradingView.

## 🎯 Функциональные требования

### 1. Выбор тикера
- Поле ввода тикера (автокомплит желательно)
- Получение текущей цены актива из Polygon API
- Отображение базовой информации (цена, изменение за день)

### 2. Форма добавления позиции
Каждая позиция должна содержать:
- **Strike** - страйк опциона (dropdown или input)
- **Type** - тип опциона (Call/Put)
- **Expiration** - дата экспирации (datepicker)
- **B/S** - направление (Buy/Sell)
- **Size** - количество контрактов (number input)
- **Price** - цена опциона (автозаполнение из API или ручной ввод)

Кнопка **"+ New position"** для добавления следующей позиции.

### 3. Интерактивный график P&L
- **Ось X**: диапазон цен базового актива (например, ±20% от текущей цены)
- **Ось Y**: прибыль/убыток в долларах
- **Линии**: каждая позиция отображается отдельной линией (разные цвета)
- **Суммарная линия**: общий P&L всех позиций (жирная линия)
- **Вертикальная линия**: текущая цена актива
- **Интерактивность**: 
  - Tooltip при наведении (показывает P&L при данной цене)
  - Zoom/Pan (опционально)
  - Легенда с позициями

### 4. Управление позициями
- Список добавленных позиций
- Возможность удалить позицию (иконка корзины)
- Возможность скрыть/показать позицию на графике (иконка глаза)
- Редактирование позиции (опционально)

### 5. Breakeven Points (точки безубыточности)
- Автоматический расчет точек безубыточности
- Отображение на графике (вертикальные пунктирные линии)
- Показывать в сводке: "Прибыль если цена выше $X или ниже $Y"

### 6. Max Profit / Max Loss
- Расчет максимальной прибыли и убытка для портфеля
- Отображение в сводке позиций
- Цена при которой достигается Max Profit/Loss

### 7. Визуальные зоны на графике
- Заливка зеленым (зона прибыли выше нуля)
- Заливка красным (зона убытка ниже нуля)
- Горизонтальная линия на уровне $0 (Break-even line)

### 8. Сохранение состояния
- localStorage для сохранения позиций
- Автосохранение при изменениях
- Возможность восстановить после перезагрузки страницы
- Кнопка "Очистить все"

### 9. Комиссии брокера
- Опциональное поле для ввода комиссии ($0.50-$1.00 за контракт стандарт)
- Учет комиссий в расчете P&L
- Настройка комиссии по умолчанию

## 🔄 Дополнительные возможности (v1.1)

### 10. Implied Volatility (IV)
- Показывать IV при выборе опциона из Polygon API
- Отображение в списке позиций
- Помогает оценить дороговизну опциона

### 11. Быстрые стратегии (пресеты)
- Кнопки-пресеты: "Long Call", "Long Put", "Bull Call Spread", "Bear Put Spread", "Iron Condor", "Straddle", "Strangle"
- Автозаполнение формы под выбранную стратегию
- Справка по каждой стратегии

### 12. Дублирование позиции
- Кнопка "Duplicate" для быстрого создания спредов
- Редактирование дублированной позиции

### 13. Валидация данных
- Expiration date не в прошлом
- Цена опциона > 0 и разумная (не больше цены актива)
- Warning для глубоких OTM опционов (Strike далеко от текущей цены)
- Проверка на логичность данных

### 14. Интеграция с Options Analyzer
- Кнопка "Добавить в калькулятор" из результатов Options Analyzer
- Переиспользование данных которые уже получили
- Единый контекст приложения

## 🚀 Расширенные возможности (v2.0)

### 15. Greeks для портфеля
- Суммарные Delta, Gamma, Theta, Vega для всего портфеля
- Показывать риски позиции
- Визуализация Greeks на отдельном графике

### 16. Probability of Profit (PoP)
- Вероятность получить прибыль на основе IV
- Использование нормального распределения
- Отображение процента и визуализация

### 17. Share functionality
- Генерация уникальной ссылки на сетап позиций
- Сохранение в БД как в Options Analyzer
- Возможность поделиться со всеми

### 18. Time to Expiration анализ
- График P&L с учетом времени до экспирации
- Показать как меняется P&L за N дней до истечения
- 3D график (цена актива, время, P&L)

## 🏗️ Архитектура

### Frontend (React)

#### Новая страница: `/tools/options-calculator`

**Компоненты:**
```
pages/
  OptionsCalculator.jsx          # Главная страница калькулятора

components/
  OptionsCalculator/
    TickerSelector.jsx           # Выбор тикера
    PositionForm.jsx             # Форма добавления позиции
    PositionsList.jsx            # Список позиций
    PositionItem.jsx             # Элемент списка позиций
    PLChart.jsx                  # График P&L (Plotly.js)
    PositionSummary.jsx          # Сводка: Max Profit/Loss, Breakeven, Комиссии
    StrategyPresets.jsx          # Быстрые стратегии (пресеты)
    CommissionSettings.jsx       # Настройки комиссий
```

**State Management:**
- Локальный state (useState) для списка позиций
- Context API (опционально, если нужно шарить между компонентами)

**Структура данных позиции:**
```javascript
{
  id: "uuid",
  strike: 432.5,
  type: "call" | "put",
  expiration: "2024-10-24",
  direction: "buy" | "sell",
  size: 1,
  price: 24.47,
  ticker: "SPY",
  visible: true,        // для скрытия/показа на графике
  iv: 0.28,             // Implied Volatility (опционально)
  commission: 0.65      // комиссия за контракт (опционально)
}
```

**Структура настроек калькулятора:**
```javascript
{
  defaultCommission: 0.65,     // комиссия по умолчанию
  priceRange: 0.20,            // диапазон цен для графика (±20%)
  chartPoints: 200,            // количество точек на графике
  autoSave: true               // автосохранение в localStorage
}
```

### Backend (FastAPI)

#### Новые эндпоинты:

1. **GET `/api/options/chain`**
   - Параметры: `ticker`, `expiration_date` (optional)
   - Возвращает: список доступных страйков и цен опционов с IV
   - Источник: Polygon API
   - Формат ответа: `[{ strike, type, price, iv, bid, ask, volume, open_interest }]`

2. **POST `/api/options/calculate-pl`**
   - Параметры: массив позиций + диапазон цен + комиссии
   - Возвращает: 
     - массив точек для графика P&L
     - breakeven points
     - max profit / max loss
     - Greeks (опционально)
   - Расчет: формулы P&L для опционов с учетом комиссий

3. **GET `/api/options/expirations`**
   - Параметры: `ticker`
   - Возвращает: список доступных дат экспирации
   - Сортировка по дате (ближайшие первые)

#### Формулы расчета P&L:

**Call опцион:**
- Buy Call: `max(0, spot_price - strike) * size * 100 - premium * size * 100`
- Sell Call: `premium * size * 100 - max(0, spot_price - strike) * size * 100`

**Put опцион:**
- Buy Put: `max(0, strike - spot_price) * size * 100 - premium * size * 100`
- Sell Put: `premium * size * 100 - max(0, strike - spot_price) * size * 100`

Где:
- `spot_price` - цена актива на момент экспирации
- `strike` - страйк опциона
- `premium` - цена опциона
- `size` - количество контрактов
- `100` - множитель (1 контракт = 100 акций)

**С учетом комиссий:**
- Для Buy позиций: `P&L - (commission * size)`
- Для Sell позиций: `P&L - (commission * size)`

**Расчет Breakeven Points:**

Для одной позиции:
- **Buy Call**: `breakeven = strike + premium + (commission / 100)`
- **Buy Put**: `breakeven = strike - premium - (commission / 100)`
- **Sell Call**: `breakeven = strike + premium - (commission / 100)`
- **Sell Put**: `breakeven = strike - premium + (commission / 100)`

Для множественных позиций - находим цены где суммарный P&L = 0 (численный метод)

**Расчет Max Profit / Max Loss:**

- Анализируем P&L график в диапазоне цен
- Max Profit = максимальное значение P&L
- Max Loss = минимальное значение P&L (или неограниченный для некоторых стратегий)

## 🛠️ Технологический стек

### Frontend библиотеки:
- **Plotly.js (react-plotly.js)** - для графиков P&L ✅
  - Мощная интерактивность (zoom, pan, hover)
  - Профессиональные финансовые графики
  - Поддержка множественных линий и аннотаций
  - Экспорт графиков (PNG, SVG)
  - Отличная производительность
  - Готовые темы для финансовых данных

### Дополнительные библиотеки:
- **date-fns** или **dayjs** - работа с датами
- **uuid** - генерация ID для позиций
- **react-select** - красивые dropdown'ы (опционально)

## 📝 План разработки (пошагово)

### Этап 1: Backend API (2-3 часа)
- [ ] Создать эндпоинт `/api/options/chain` для получения опционной цепочки с IV
- [ ] Создать эндпоинт `/api/options/expirations` для дат экспирации
- [ ] Создать функцию расчета P&L для одной позиции (с комиссиями)
- [ ] Создать функцию расчета Breakeven Points
- [ ] Создать функцию расчета Max Profit / Max Loss
- [ ] Создать эндпоинт `/api/options/calculate-pl` для расчета графика
- [ ] Протестировать все API эндпоинты

### Этап 2: Frontend - базовая структура (1 час)
- [ ] Создать страницу `/tools/options-calculator`
- [ ] Добавить роут в `App.js`
- [ ] Создать базовую разметку (2 колонки: форма слева, график справа)
- [ ] Установить Plotly: `npm install react-plotly.js plotly.js`

### Этап 3: Компонент выбора тикера (30 мин)
- [ ] Создать `TickerSelector.jsx`
- [ ] Интеграция с API для получения цены
- [ ] Отображение текущей цены

### Этап 4: Форма добавления позиции (2 часа)
- [ ] Создать `PositionForm.jsx`
- [ ] Все поля формы (Strike, Type, Expiration, B/S, Size, Price, Commission)
- [ ] Валидация полей (дата не в прошлом, цена > 0, разумные значения)
- [ ] Интеграция с API для получения страйков и цен (с IV)
- [ ] Автозаполнение цены опциона из API
- [ ] Обработка submit - добавление позиции в state
- [ ] Warnings для OTM опционов

### Этап 5: Список позиций и сводка (1.5 часа)
- [ ] Создать `PositionsList.jsx` и `PositionItem.jsx`
- [ ] Отображение списка позиций с IV
- [ ] Кнопка удаления позиции
- [ ] Кнопка скрыть/показать позицию на графике
- [ ] Кнопка дублирования позиции
- [ ] Создать `PositionSummary.jsx`
- [ ] Отображение Max Profit / Max Loss
- [ ] Отображение Breakeven Points
- [ ] Отображение суммарной стоимости позиций и комиссий

### Этап 6: График P&L с Plotly.js (3-4 часа)
- [ ] Создать `PLChart.jsx` с Plotly.js
- [ ] Расчет точек для графика (с учетом комиссий)
- [ ] Отображение линий для каждой позиции (разные цвета и стили)
- [ ] Суммарная линия P&L (жирная линия)
- [ ] Вертикальная линия текущей цены (shape annotation)
- [ ] Горизонтальная линия на уровне $0 (break-even line)
- [ ] Вертикальные линии Breakeven Points (пунктирные)
- [ ] Заливка зон прибыли (зеленый) и убытка (красный)
- [ ] Интерактивный tooltip с детальной информацией
- [ ] Легенда с возможностью скрыть/показать линии
- [ ] Настройка layout (темная тема, сетка, оси)
- [ ] Кнопки управления (zoom, pan, reset, export PNG)

### Этап 7: localStorage и настройки комиссий (1 час)
- [ ] Создать `CommissionSettings.jsx`
- [ ] Настройка комиссии по умолчанию
- [ ] Сохранение позиций в localStorage при изменениях
- [ ] Восстановление позиций при загрузке страницы
- [ ] Кнопка "Очистить все позиции"
- [ ] Сохранение настроек калькулятора

### Этап 8: Интеграция и тестирование (1.5 часа)
- [ ] Связать все компоненты
- [ ] Тестирование различных сценариев:
  - Одна позиция (Call/Put, Buy/Sell)
  - Несколько позиций
  - Комбинированные стратегии (Bull Spread, Bear Spread, Straddle, Iron Condor)
  - С комиссиями и без
- [ ] Обработка ошибок и edge cases
- [ ] Адаптивность (мобильная версия)
- [ ] Проверка производительности (много позиций)

### Этап 9: Быстрые стратегии (пресеты) - v1.1 (2 часа)
- [ ] Создать `StrategyPresets.jsx`
- [ ] Реализовать пресеты:
  - Long Call / Long Put
  - Bull Call Spread / Bear Put Spread
  - Iron Condor
  - Straddle / Strangle
  - Butterfly
- [ ] Автозаполнение формы при выборе стратегии
- [ ] Справка по каждой стратегии

### Этап 10: Расширенные улучшения - v2.0 (опционально, 5+ часов)
- [ ] Анализ Greeks (Delta, Gamma, Theta, Vega) для портфеля
- [ ] Вероятность прибыли (PoP) на основе IV
- [ ] Time to Expiration анализ (график во времени)
- [ ] Share functionality (сохранение в БД, ссылка)
- [ ] Интеграция с Options Analyzer
- [ ] Экспорт в PDF с отчетом

## 🎨 UI/UX дизайн

### Макет страницы:
```
┌─────────────────────────────────────────────────────────────────────┐
│  Header (Navigation) - Options Calculator                           │
├──────────────────────┬──────────────────────────────────────────────┤
│                      │                                              │
│  Ticker Selector     │  ┌──────────────────────────────────────┐   │
│  ┌────────────────┐  │  │  Position Summary                     │   │
│  │ SPY        ▼  │  │  │  Max Profit: $1,200                  │   │
│  └────────────────┘  │  │  Max Loss: -$800                     │   │
│  $432.50 (+1.2%)     │  │  Breakeven: $435.15, $427.85         │   │
│                      │  │  Total Cost: $2,447                  │   │
│  Commission: $0.65   │  │  Commission: $6.50                   │   │
│  [Settings]          │  └──────────────────────────────────────┘   │
│                      │                                              │
│  Position Form       │         P&L Chart (Plotly.js)                │
│  ┌────────────────┐  │    ┌────────────────────────────────────┐   │
│  │ Strike         │  │    │                                    │   │
│  │ Type (Call/Put)│  │    │   [График с линиями позиций]       │   │
│  │ Expiration     │  │    │   - Зоны прибыли/убытка (заливка)  │   │
│  │ B/S (Buy/Sell) │  │    │   - Breakeven lines                │   │
│  │ Size           │  │    │   - Текущая цена линия             │   │
│  │ Price (IV: 28%)│  │    │   - Tooltip с информацией          │   │
│  │ Commission     │  │    │                                    │   │
│  └────────────────┘  │    └────────────────────────────────────┘   │
│  [+ New position]    │    [Zoom] [Pan] [Reset] [Export PNG]        │
│  [Strategy Presets▼] │                                              │
│                      │                                              │
│  Positions List      │                                              │
│  ┌────────────────┐  │                                              │
│  │ Buy Call 432.5 │  │                                              │
│  │ $24.47 x1 👁 📋🗑│ │                                              │
│  ├────────────────┤  │                                              │
│  │ Sell Put 430.0 │  │                                              │
│  │ $18.20 x1 👁 📋🗑│ │                                              │
│  └────────────────┘  │                                              │
│  [Clear All]         │                                              │
└──────────────────────┴──────────────────────────────────────────────┘
```

### Цветовая схема:
- **Call опционы**: синий/голубой (#3B82F6)
- **Put опционы**: оранжевый/красный (#F97316)
- **Buy позиции**: сплошная линия (solid)
- **Sell позиции**: пунктирная линия (dash)
- **Суммарный P&L**: 
  - Зеленый для прибыли (#10B981)
  - Красный для убытка (#EF4444)
  - Жирная линия (width: 3)
- **Текущая цена**: белая вертикальная линия (#FFFFFF)
- **Breakeven Points**: желтые пунктирные линии (#FBBF24)
- **Zero line**: серая горизонтальная линия (#6B7280)
- **Зоны заливки**:
  - Прибыль: светло-зеленая с прозрачностью (#10B981, opacity: 0.1)
  - Убыток: светло-красная с прозрачностью (#EF4444, opacity: 0.1)

## ⚠️ Потенциальные проблемы и решения

### 1. Производительность графика
**Проблема**: Много позиций → медленный рендеринг
**Решение**: 
- Ограничить количество точек на графике (100-200 точек достаточно)
- Использовать `useMemo` для расчетов
- Виртуализация списка позиций (react-window)

### 2. Точность расчетов
**Проблема**: Расчет P&L не учитывает временную стоимость (Greeks)
**Решение**: 
- Для MVP: расчет на экспирацию (без временной стоимости)
- Для v2: добавить Black-Scholes модель для учета времени

### 3. Данные из Polygon API
**Проблема**: Лимиты API, задержки
**Решение**:
- Кэширование опционной цепочки (5-10 минут)
- Fallback на Yahoo Finance
- Возможность ручного ввода цен

### 4. Мобильная версия
**Проблема**: График плохо отображается на маленьких экранах
**Решение**:
- Вертикальная раскладка (форма сверху, график снизу)
- Упрощенный график для мобильных
- Свайпы для навигации между позициями

## 📊 Оценка времени

**MVP с основными фичами (Этапы 1-8):**
- Этап 1: Backend API (с breakeven, max profit/loss): 3 часа
- Этап 2: Frontend структура: 1 час
- Этап 3: Выбор тикера: 0.5 часа
- Этап 4: Форма позиций (с валидацией, IV): 2 часа
- Этап 5: Список позиций и сводка: 1.5 часа
- Этап 6: График P&L с Plotly (заливки, breakeven lines): 4 часа
- Этап 7: localStorage и комиссии: 1 час
- Этап 8: Тестирование и интеграция: 1.5 часа
**Итого MVP: ~14.5 часов**

**v1.1 с быстрыми стратегиями (Этап 9):**
- MVP: 14.5 часов
- Пресеты стратегий: 2 часа
**Итого v1.1: ~16.5 часов**

**v2.0 с расширенными возможностями (Этап 10):**
- v1.1: 16.5 часов
- Greeks для портфеля: 3 часа
- Probability of Profit: 2 часа
- Time to Expiration анализ: 3 часа
- Share functionality: 2 часа
- Интеграция с Options Analyzer: 2 часа
- Полировка UI/UX и мобильная версия: 2 часа
**Итого v2.0: ~30.5 часов**

## 🚀 Следующие шаги

1. ✅ **План утвержден** - используем Plotly.js
2. **Начать с Backend API** (эндпоинты для опционной цепочки)
3. **Создать базовую страницу** и форму
4. **Реализовать график P&L с Plotly.js**
5. **Тестирование и итерации**

## 📚 Полезные ресурсы

- [Plotly.js Documentation](https://plotly.com/javascript/)
- [React-Plotly.js](https://plotly.com/javascript/react/)
- [Plotly Financial Charts](https://plotly.com/javascript/financial-charts/)
- [Options P&L Calculator Math](https://www.optionsprofitcalculator.com/)
- [Black-Scholes Model](https://en.wikipedia.org/wiki/Black%E2%80%93Scholes_model)
- [Polygon Options API](https://polygon.io/docs/options/getting-started)

---

## 📝 История изменений

**v1.1 - 2025-10-10 16:28**
- ✅ Добавлены критически важные фичи для MVP:
  - Breakeven Points (расчет и отображение)
  - Max Profit / Max Loss
  - Визуальные зоны на графике (заливка прибыли/убытка)
  - localStorage для сохранения позиций
  - Комиссии брокера
- ✅ Дополнительные возможности v1.1:
  - Implied Volatility (IV)
  - Быстрые стратегии (пресеты)
  - Дублирование позиций
  - Валидация данных
  - Интеграция с Options Analyzer
- ✅ Расширенные возможности v2.0:
  - Greeks для портфеля
  - Probability of Profit (PoP)
  - Share functionality
  - Time to Expiration анализ
- ✅ Обновлена архитектура компонентов
- ✅ Обновлены формулы расчетов (с комиссиями и breakeven)
- ✅ Обновлен UI/UX макет
- ✅ Обновлена оценка времени: MVP ~14.5ч, v1.1 ~16.5ч, v2.0 ~30.5ч

**v1.0 - 2025-10-10 16:10**
- Первоначальная версия плана
- Базовая архитектура
- Выбран Plotly.js для графиков

---

**Статус**: ✅ План утвержден и дополнен  
**Текущая версия**: v1.1  
**Дата обновления**: 2025-10-10  
**Автор**: Cascade AI

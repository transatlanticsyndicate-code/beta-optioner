# üìä –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –ø–µ—Ä–µ–¥–∞—á–∏ –¥–ª—è IB API

**–î–∞—Ç–∞:** 22 –æ–∫—Ç—è–±—Ä—è 2025  
**–¶–µ–ª—å:** –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–∞–∫–∏–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –Ω—É–∂–Ω—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

---

## üéØ –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –ø–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º

### 1. **Options Analyzer** (—Ç–µ–∫—É—â–∏–π)

**–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö:** REST API (–∑–∞–ø—Ä–æ—Å-–æ—Ç–≤–µ—Ç)

**–ß—Ç–æ –Ω—É–∂–Ω–æ:**
- ‚úÖ –û–ø—Ü–∏–æ–Ω–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞ (–æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ)
- ‚úÖ –¶–µ–Ω–∞ –±–∞–∑–æ–≤–æ–≥–æ –∞–∫—Ç–∏–≤–∞ (–æ–¥–∏–Ω —Ä–∞–∑)
- ‚úÖ Greeks (—Ä–∞—Å—á–µ—Ç –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ)
- ‚úÖ IV Rank (–∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ)

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è:** REST API  
**–ß–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** –ü–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ IB REST API

---

### 2. **Trade Plan** (—Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º)

**–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö:** REST API + –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

**–ß—Ç–æ –Ω—É–∂–Ω–æ:**
- ‚úÖ –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ (–¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤)
- ‚úÖ –ë–∞–ª–∞–Ω—Å —Å—á–µ—Ç–∞
- ‚úÖ Buying Power
- ‚úÖ –û–ø—Ü–∏–æ–Ω–Ω—ã–µ —Ü–µ–Ω—ã (–¥–ª—è entry/exit)
- ‚úÖ Greeks (–¥–ª—è risk analysis)
- ‚ö†Ô∏è **Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è P&L** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è:** 
- REST API –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞–Ω–∞ ‚úÖ
- WebSocket –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ‚ö†Ô∏è

**–ß–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞–Ω–∞: –æ–¥–∏–Ω —Ä–∞–∑
- –ü—Ä–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ: –∫–∞–∂–¥—ã–µ 1-5 —Å–µ–∫—É–Ω–¥

**–°—Ç–∞—Ç—É—Å:** ‚úÖ REST API –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è MVP

---

### 3. **Portfolio View** (–±—É–¥—É—â–µ–µ)

**–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö:** REST API + Real-time streaming

**–ß—Ç–æ –Ω—É–∂–Ω–æ:**
- ‚úÖ –û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏
- ‚úÖ P&L (Unrealized + Realized)
- ‚úÖ –¢–µ–∫—É—â–∏–µ —Ü–µ–Ω—ã –ø–æ–∑–∏—Ü–∏–π
- üî• **Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–Ω** (–≤–∞–∂–Ω–æ!)
- üî• **Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è P&L** (–≤–∞–∂–Ω–æ!)

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è:**
- REST API –¥–ª—è –Ω–∞—á–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ ‚úÖ
- **WebSocket –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π** üî•

**–ß–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 
- –ö–∞–∂–¥—ã–µ 1-3 —Å–µ–∫—É–Ω–¥—ã (–≤–æ –≤—Ä–µ–º—è —Ç–æ—Ä–≥–æ–≤–ª–∏)
- –ö–∞–∂–¥—ã–µ 5-10 —Å–µ–∫—É–Ω–¥ (–≤–Ω–µ —Ç–æ—Ä–≥–æ–≤–ª–∏)

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –ù—É–∂–µ–Ω WebSocket –¥–ª—è —Ö–æ—Ä–æ—à–µ–≥–æ UX

---

### 4. **Live Trading** (–±—É–¥—É—â–µ–µ)

**–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö:** REST API + Real-time streaming

**–ß—Ç–æ –Ω—É–∂–Ω–æ:**
- ‚úÖ –†–∞–∑–º–µ—â–µ–Ω–∏–µ –æ—Ä–¥–µ—Ä–æ–≤ (REST)
- üî• **–°—Ç–∞—Ç—É—Å –æ—Ä–¥–µ—Ä–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏**
- üî• **–¶–µ–Ω—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—Ö–æ–¥–∞**
- üî• **–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ä–¥–µ—Ä–æ–≤ (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)**

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è:**
- REST API –¥–ª—è –æ—Ä–¥–µ—Ä–æ–≤ ‚úÖ
- **WebSocket –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π** üî•

**–ß–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ (< 1 —Å–µ–∫)

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–Ω–æ –Ω—É–∂–µ–Ω WebSocket

---

### 5. **Market Scanner** (–±—É–¥—É—â–µ–µ)

**–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö:** Real-time streaming

**–ß—Ç–æ –Ω—É–∂–Ω–æ:**
- üî• **–¶–µ–Ω—ã –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —Ç–∏–∫–µ—Ä–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ**
- üî• **–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É**
- üî• **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —É—Å–ª–æ–≤–∏—è–º**

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è:** **WebSocket –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω** üî•

**–ß–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 1-3 —Å–µ–∫—É–Ω–¥—ã

**–°—Ç–∞—Ç—É—Å:** ‚ùå –ë–µ–∑ WebSocket –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω

---

## üåê WebSocket –≤ IB API

### –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å:

**IB Client Portal API –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç WebSocket!** ‚úÖ

**Endpoints:**
```
wss://localhost:5000/v1/api/ws
```

**–ß—Ç–æ –º–æ–∂–Ω–æ —Å—Ç—Ä–∏–º–∏—Ç—å:**
- ‚úÖ Market data (—Ü–µ–Ω—ã –∞–∫—Ü–∏–π, –æ–ø—Ü–∏–æ–Ω–æ–≤)
- ‚úÖ Account updates (–±–∞–ª–∞–Ω—Å, –ø–æ–∑–∏—Ü–∏–∏)
- ‚úÖ Order updates (—Å—Ç–∞—Ç—É—Å—ã –æ—Ä–¥–µ—Ä–æ–≤)
- ‚úÖ P&L updates

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:

```javascript
// Frontend
const ws = new WebSocket('ws://localhost:8000/ws/market-data');

ws.onopen = () => {
  // –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Ç–∏–∫–µ—Ä—ã
  ws.send(JSON.stringify({
    action: 'subscribe',
    tickers: ['SPY', 'AAPL', 'QQQ']
  }));
};

ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  // –û–±–Ω–æ–≤–∏—Ç—å UI —Å –Ω–æ–≤—ã–º–∏ —Ü–µ–Ω–∞–º–∏
  updatePrices(data);
};
```

```python
# Backend (FastAPI)
from fastapi import WebSocket

@app.websocket("/ws/market-data")
async def websocket_endpoint(websocket: WebSocket):
    await websocket.accept()
    
    # –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ IB WebSocket
    ib_ws = IBWebSocket()
    
    while True:
        # –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ—Ç IB
        data = await ib_ws.receive()
        
        # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É
        await websocket.send_json(data)
```

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π

### REST API (–∑–∞–ø—Ä–æ—Å-–æ—Ç–≤–µ—Ç)

**–ü–ª—é—Å—ã:**
- ‚úÖ –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
- ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- ‚úÖ –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ä–µ–¥–∫–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå –ó–∞–¥–µ—Ä–∂–∫–∞ (–Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å)
- ‚ùå Polling (–ª–∏—à–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã)
- ‚ùå –ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è real-time

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- Options Analyzer ‚úÖ
- Trade Plan (—Å–æ–∑–¥–∞–Ω–∏–µ) ‚úÖ
- –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ ‚úÖ

---

### WebSocket (streaming)

**–ü–ª—é—Å—ã:**
- ‚úÖ Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- ‚úÖ –ù–∏–∑–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (< 100ms)
- ‚úÖ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ (–æ–¥–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ)
- ‚úÖ Server push (–Ω–µ –Ω—É–∂–µ–Ω polling)

**–ú–∏–Ω—É—Å—ã:**
- ‚ö†Ô∏è –°–ª–æ–∂–Ω–µ–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
- ‚ö†Ô∏è –ù—É–∂–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º
- ‚ö†Ô∏è Reconnect logic

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- Portfolio (real-time P&L) üî•
- Live Trading (—Å—Ç–∞—Ç—É—Å—ã –æ—Ä–¥–µ—Ä–æ–≤) üî•
- Market Scanner üî•
- Trade Plan (–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥) üí°

---

### Server-Sent Events (SSE)

**–ü–ª—é—Å—ã:**
- ‚úÖ –ü—Ä–æ—â–µ —á–µ–º WebSocket
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π reconnect
- ‚úÖ HTTP/2 friendly

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå –¢–æ–ª—å–∫–æ server ‚Üí client
- ‚ùå –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è IB API

**–°—Ç–∞—Ç—É—Å:** ‚ùå –ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è IB

---

### Polling (–ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã)

**–ü–ª—é—Å—ã:**
- ‚úÖ –û—á–µ–Ω—å –ø—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –≤–µ–∑–¥–µ

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå –ó–∞–¥–µ—Ä–∂–∫–∞ (5-30 —Å–µ–∫—É–Ω–¥)
- ‚ùå –õ–∏—à–Ω—è—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ API
- ‚ùå –ü–ª–æ—Ö–æ–π UX

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- Fallback –µ—Å–ª–∏ WebSocket –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
- –†–µ–¥–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (> 30 —Å–µ–∫)

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —ç—Ç–∞–ø–∞–º

### –≠—Ç–∞–ø 1: MVP (–°–ï–ô–ß–ê–°) ‚úÖ

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** REST API —Ç–æ–ª—å–∫–æ

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- ‚úÖ Options Analyzer
- ‚úÖ Trade Plan (—Å–æ–∑–¥–∞–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ)
- ‚úÖ Portfolio (—Å—Ç–∞—Ç–∏—á–Ω—ã–π snapshot)

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è:** REST API  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –∑–∞–ø—É—Å–∫–∞

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
- –ë—ã—Å—Ç—Ä–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
- –ü—Ä–æ—Å—Ç–∞—è –æ—Ç–ª–∞–¥–∫–∞
- –ü–æ–∫—Ä—ã–≤–∞–µ—Ç 80% use cases

---

### –≠—Ç–∞–ø 2: Enhanced (–ß–ï–†–ï–ó 2-3 –ù–ï–î–ï–õ–ò) üí°

**–î–æ–±–∞–≤–∏—Ç—å:** WebSocket –¥–ª—è Portfolio

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- ‚úÖ REST API (–±–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å)
- üî• WebSocket –¥–ª—è Portfolio (real-time P&L)
- üí° WebSocket –¥–ª—è Trade Plan (–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è:** REST API + WebSocket  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°–†–ï–î–ù–ò–ô

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
- –£–ª—É—á—à–∞–µ—Ç UX Portfolio
- –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã
- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ

---

### –≠—Ç–∞–ø 3: Advanced (–ß–ï–†–ï–ó 1-2 –ú–ï–°–Ø–¶–ê) üöÄ

**–î–æ–±–∞–≤–∏—Ç—å:** WebSocket –¥–ª—è Trading

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- üî• Live Trading (real-time —Å—Ç–∞—Ç—É—Å—ã)
- üî• Market Scanner
- üî• Alerts & Notifications

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è:** –ü–æ–ª–Ω—ã–π WebSocket  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ù–ò–ó–ö–ò–ô (–ø–æ–∫–∞)

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
- –ù—É–∂–Ω–æ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–ª–∏
- –¢—Ä–µ–±—É–µ—Ç –±–æ–ª—å—à–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- –ú–æ–∂–Ω–æ –æ—Ç–ª–æ–∂–∏—Ç—å

---

## üîß –†–µ–∞–ª–∏–∑–∞—Ü–∏—è WebSocket

### Backend (FastAPI)

**–°–æ–∑–¥–∞—Ç—å `/backend/app/services/ib_websocket.py`:**

```python
"""
WebSocket –∫–ª–∏–µ–Ω—Ç –¥–ª—è IB API
"""
import asyncio
import websockets
import json
from typing import Callable, List

class IBWebSocketClient:
    """WebSocket –¥–ª—è streaming –¥–∞–Ω–Ω—ã—Ö –æ—Ç IB"""
    
    def __init__(self):
        self.url = "wss://localhost:5000/v1/api/ws"
        self.ws = None
        self.subscriptions = set()
    
    async def connect(self):
        """–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ IB WebSocket"""
        self.ws = await websockets.connect(
            self.url,
            ssl=False  # Self-signed cert
        )
    
    async def subscribe_market_data(self, conids: List[int]):
        """–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ market data"""
        for conid in conids:
            await self.ws.send(json.dumps({
                "action": "subscribe",
                "conid": conid,
                "fields": ["31", "84", "86"]  # Last, Bid, Ask
            }))
            self.subscriptions.add(conid)
    
    async def receive(self):
        """–ü–æ–ª—É—á–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ"""
        message = await self.ws.recv()
        return json.loads(message)
    
    async def close(self):
        """–ó–∞–∫—Ä—ã—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ"""
        if self.ws:
            await self.ws.close()
```

**–°–æ–∑–¥–∞—Ç—å WebSocket endpoint:**

```python
# /backend/app/routers/websocket.py

from fastapi import WebSocket, WebSocketDisconnect
from app.services.ib_websocket import IBWebSocketClient

@app.websocket("/ws/market-data")
async def websocket_market_data(websocket: WebSocket):
    await websocket.accept()
    
    ib_ws = IBWebSocketClient()
    await ib_ws.connect()
    
    try:
        while True:
            # –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ (–ø–æ–¥–ø–∏—Å–∫–∏)
            client_msg = await websocket.receive_json()
            
            if client_msg["action"] == "subscribe":
                conids = client_msg["conids"]
                await ib_ws.subscribe_market_data(conids)
            
            # –ü–æ–ª—É—á–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç IB
            ib_data = await ib_ws.receive()
            
            # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É
            await websocket.send_json(ib_data)
            
    except WebSocketDisconnect:
        await ib_ws.close()
```

### Frontend (React)

**–°–æ–∑–¥–∞—Ç—å `/frontend/src/hooks/useMarketData.js`:**

```javascript
import { useState, useEffect, useRef } from 'react';

export function useMarketData(tickers) {
  const [prices, setPrices] = useState({});
  const ws = useRef(null);
  
  useEffect(() => {
    // –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ WebSocket
    ws.current = new WebSocket('ws://localhost:8000/ws/market-data');
    
    ws.current.onopen = () => {
      // –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Ç–∏–∫–µ—Ä—ã
      ws.current.send(JSON.stringify({
        action: 'subscribe',
        tickers: tickers
      }));
    };
    
    ws.current.onmessage = (event) => {
      const data = JSON.parse(event.data);
      
      // –û–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—ã
      setPrices(prev => ({
        ...prev,
        [data.ticker]: data.price
      }));
    };
    
    return () => {
      ws.current.close();
    };
  }, [tickers]);
  
  return prices;
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ:**

```javascript
function Portfolio() {
  const prices = useMarketData(['SPY', 'AAPL', 'QQQ']);
  
  return (
    <div>
      <h1>Portfolio</h1>
      <div>SPY: ${prices.SPY || 'Loading...'}</div>
      <div>AAPL: ${prices.AAPL || 'Loading...'}</div>
      <div>QQQ: ${prices.QQQ || 'Loading...'}</div>
    </div>
  );
}
```

---

## ‚úÖ –ò—Ç–æ–≥–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

### –ß—Ç–æ –ï–°–¢–¨ —Å–µ–π—á–∞—Å:

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –î–∞–Ω–Ω—ã–µ | –°—Ç–∞—Ç—É—Å |
|-----------|------------|--------|--------|
| **Options Analyzer** | REST API | –û–ø—Ü–∏–æ–Ω—ã, Greeks | ‚úÖ –ì–æ—Ç–æ–≤ |
| **Trade Plan** | REST API | –¶–µ–Ω—ã, Portfolio | ‚úÖ –ì–æ—Ç–æ–≤ |
| **Portfolio (static)** | REST API | –ü–æ–∑–∏—Ü–∏–∏, P&L | ‚úÖ –ì–æ—Ç–æ–≤ |
| **Market Data** | REST API | Real-time —Ü–µ–Ω—ã | ‚úÖ –ì–æ—Ç–æ–≤ |

### –ß—Ç–æ –ù–£–ñ–ù–û –¥–æ–±–∞–≤–∏—Ç—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –ö–æ–≥–¥–∞ |
|-----------|------------|-----------|-------|
| Portfolio (real-time) | WebSocket | üí° –°—Ä–µ–¥–Ω–∏–π | –≠—Ç–∞–ø 2 |
| Trade Plan (monitor) | WebSocket | üí° –ù–∏–∑–∫–∏–π | –≠—Ç–∞–ø 2 |
| Live Trading | WebSocket | üî• –í—ã—Å–æ–∫–∏–π | –≠—Ç–∞–ø 3 |
| Market Scanner | WebSocket | üí° –°—Ä–µ–¥–Ω–∏–π | –≠—Ç–∞–ø 3 |

---

## üéØ –§–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### ‚úÖ –ù–ê–ß–ò–ù–ê–¢–¨ –†–ê–ë–û–¢–£ –ú–û–ñ–ù–û –ü–†–Ø–ú–û –°–ï–ô–ß–ê–°!

**–ü—Ä–∏—á–∏–Ω—ã:**
1. ‚úÖ REST API –ø–æ–ª–Ω–æ—Å—Ç—å—é –¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω –¥–ª—è MVP
2. ‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã
3. ‚úÖ WebSocket –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç)
4. ‚úÖ 80% —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ WebSocket

### üìã –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π:

**–≠—Ç–∞–ø 1 (–°–ï–ô–ß–ê–° - 2 –Ω–µ–¥–µ–ª–∏):**
1. ‚úÖ –ó–∞–∫–æ–º–º–∏—Ç–∏—Ç—å IB Client (REST API)
2. ‚úÖ –†–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å –ê–¥–∞–ø—Ç–µ—Ä
3. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Trade Plan MVP (REST)
4. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å Portfolio (REST)

**–≠—Ç–∞–ø 2 (–ß–ï–†–ï–ó 2-3 –ù–ï–î–ï–õ–ò):**
1. üí° –î–æ–±–∞–≤–∏—Ç—å WebSocket –¥–ª—è Portfolio
2. üí° Real-time P&L –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
3. üí° Trade Plan –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–≠—Ç–∞–ø 3 (–ß–ï–†–ï–ó 1-2 –ú–ï–°–Ø–¶–ê):**
1. üî• Live Trading —Å WebSocket
2. üî• Market Scanner
3. üî• Alerts

---

## üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### REST API:
- **–ó–∞–¥–µ—Ä–∂–∫–∞:** 200-500ms
- **–ß–∞—Å—Ç–æ—Ç–∞:** –ü–æ –∑–∞–ø—Ä–æ—Å—É
- **–°—Ç–æ–∏–º–æ—Å—Ç—å:** –í–∫–ª—é—á–µ–Ω–æ –≤ –ø–æ–¥–ø–∏—Å–∫—É
- **–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è:** 80% use cases

### WebSocket:
- **–ó–∞–¥–µ—Ä–∂–∫–∞:** 50-100ms
- **–ß–∞—Å—Ç–æ—Ç–∞:** Real-time (1-3 —Å–µ–∫)
- **–°—Ç–æ–∏–º–æ—Å—Ç—å:** –í–∫–ª—é—á–µ–Ω–æ –≤ –ø–æ–¥–ø–∏—Å–∫—É
- **–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è:** Real-time –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

---

## ‚úÖ –í–´–í–û–î

**–ú–æ–∂–µ–º –Ω–∞—á–∏–Ω–∞—Ç—å —Ä–∞–±–æ—Ç—É –ë–ï–ó WebSocket!**

- ‚úÖ REST API –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- ‚úÖ Trade Plan —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ —Å REST
- ‚úÖ Portfolio –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ snapshot (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ –∫–Ω–æ–ø–∫–µ)
- üí° WebSocket –¥–æ–±–∞–≤–∏–º –ø–æ–∑–∂–µ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è UX
- üî• WebSocket –∫—Ä–∏—Ç–∏—á–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è Live Trading

**WebSocket –ù–ï –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É!** üöÄ

---

**–ì–æ—Ç–æ–≤—ã –Ω–∞—á–∏–Ω–∞—Ç—å –≠—Ç–∞–ø 1?**

# Selenium + Client Portal Gateway Setup

## üåê –ß—Ç–æ —ç—Ç–æ?

Selenium –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **Client Portal Gateway** –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ **–±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è OAuth 2.0 credentials**.

## üéØ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **Selenium –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –±—Ä–∞—É–∑–µ—Ä**
2. **–í—ã –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç–µ—Å—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ** (–≤—Ä—É—á–Ω—É—é)
3. **Selenium –ø–æ–ª—É—á–∞–µ—Ç cookies** –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞
4. **Python –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–∏ cookies** –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤
5. **–í—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!**

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```bash
cd backend
pip install selenium
```

### –®–∞–≥ 2: –°–∫–∞—á–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å Gateway

```bash
# –°–∫–∞—á–∞—Ç—å Gateway (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —Å–∫–∞—á–∞–Ω)
wget https://download2.interactivebrokers.com/portal/clientportal.gw.zip
unzip clientportal.gw.zip

# –ó–∞–ø—É—Å—Ç–∏—Ç—å Gateway
cd clientportal.gw
bin/run.sh root/conf.yaml
```

Gateway –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –Ω–∞ `https://localhost:5001`

### –®–∞–≥ 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Selenium –≤ –∫–æ–¥–µ

```python
import os
os.environ["IB_USE_SELENIUM"] = "1"

from app.services.ib_client_hybrid import IBClientHybrid

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–∫—Ä–æ–µ—Ç –±—Ä–∞—É–∑–µ—Ä
client = IBClientHybrid()

# –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ –∫–æ–≥–¥–∞ –æ–Ω –æ—Ç–∫—Ä–æ–µ—Ç—Å—è
# Selenium –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∏—Ç cookies

# –¢–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç
price = client.get_stock_price("SPY")
print(f"SPY: ${price['price']}")
```

### –®–∞–≥ 4: –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç

```bash
cd backend
python test_selenium.py
```

–ë—Ä–∞—É–∑–µ—Ä –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ, –∏ —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç—É.

## üìã –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

```python
if os.getenv("IB_OAUTH_CLIENT_ID"):
    # Production: OAuth 2.0
    auth = IBOAuth2Auth()
elif os.getenv("IB_USE_SELENIUM") == "1":
    # Development: Selenium + Gateway
    auth = IBSeleniumAuth()
else:
    # Development: Gateway (–±–µ–∑ Selenium)
    auth = IBClientPortalGatewayAuth()
```

### –ü—Ä–æ—Ü–µ—Å—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Selenium

1. **–û—Ç–∫—Ä—ã—Ç—å –±—Ä–∞—É–∑–µ—Ä** ‚Üí `https://localhost:5001`
2. **–ñ–¥–∞—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏** ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
3. **–ü–æ–ª—É—á–∏—Ç—å cookies** ‚Üí –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞
4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å** ‚Üí `/v1/portal/iserver/auth/status`
5. **–ï—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω** ‚Üí –∑–∞–∫—Ä—ã—Ç—å –±—Ä–∞—É–∑–µ—Ä –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å cookies
6. **–ï—Å–ª–∏ timeout** ‚Üí –æ—à–∏–±–∫–∞ (5 –º–∏–Ω—É—Ç –º–∞–∫—Å–∏–º—É–º)

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

‚úÖ **–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å** - –Ω–µ –Ω—É–∂–Ω–æ –∂–¥–∞—Ç—å credentials
‚úÖ **–†–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ** - —Å Gateway
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** - Selenium –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –±—Ä–∞—É–∑–µ—Ä
‚úÖ **–û–¥–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è** - `IB_USE_SELENIUM=1`
‚úÖ **–õ–µ–≥–∫–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è** - –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é

## ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

‚ùå **–¢—Ä–µ–±—É–µ—Ç –±—Ä–∞—É–∑–µ—Ä** - Chrome/Chromium –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
‚ùå **–ú–µ–¥–ª–µ–Ω–Ω–µ–µ** - —á–µ–º –ø—Ä—è–º—ã–µ API –∑–∞–ø—Ä–æ—Å—ã
‚ùå **–ù–µ –¥–ª—è production** - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ OAuth 2.0
‚ùå **–ó–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–µ—Ä—Å–∏–∏ –±—Ä–∞—É–∑–µ—Ä–∞** - –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å headless —Ä–µ–∂–∏–º (–±–µ–∑ –æ–∫–Ω–∞ –±—Ä–∞—É–∑–µ—Ä–∞)

```python
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ib_auth.py
class IBSeleniumAuth(IBAuthBase):
    def __init__(self, headless: bool = True):  # –ò–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ True
        ...
```

### –ò–∑–º–µ–Ω–∏—Ç—å URL Gateway

```bash
export IB_GATEWAY_URL=https://localhost:5001
python test_selenium.py
```

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–ø–æ—Å–æ–±–æ–≤

| –ö—Ä–∏—Ç–µ—Ä–∏–π | Selenium | OAuth 2.0 |
|----------|----------|-----------|
| –£—Å—Ç–∞–Ω–æ–≤–∫–∞ | –õ–µ–≥–∫–æ | –ñ–¥–µ–º credentials |
| –°–∫–æ—Ä–æ—Å—Ç—å | –ú–µ–¥–ª–µ–Ω–Ω–æ | –ë—ã—Å—Ç—Ä–æ |
| –ë—Ä–∞—É–∑–µ—Ä | –¢—Ä–µ–±—É–µ—Ç—Å—è | –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è |
| Production | ‚ùå –ù–µ—Ç | ‚úÖ –î–∞ |
| –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ | ‚úÖ –î–∞ | ‚úÖ –î–∞ |
| –°–ª–æ–∂–Ω–æ—Å—Ç—å | –°—Ä–µ–¥–Ω—è—è | –ü—Ä–æ—Å—Ç–∞—è |

## üÜò Troubleshooting

### –û—à–∏–±–∫–∞: "Selenium –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

```bash
pip install selenium
```

### –û—à–∏–±–∫–∞: "Chrome –Ω–µ –Ω–∞–π–¥–µ–Ω"

–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ Chrome/Chromium —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:

```bash
# Mac
brew install chromium

# Linux
sudo apt-get install chromium-browser

# Windows
# –°–∫–∞—á–∞–π—Ç–µ —Å https://www.google.com/chrome/
```

### –û—à–∏–±–∫–∞: "Timeout: –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –∑–∞ 5 –º–∏–Ω—É—Ç"

–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ –±—ã—Å—Ç—Ä–µ–µ. –ï—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

1. Gateway –∑–∞–ø—É—â–µ–Ω –Ω–∞ `https://localhost:5001`
2. Chrome/Chromium —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
3. –ù–µ—Ç –¥—Ä—É–≥–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ Chrome

### –û—à–∏–±–∫–∞: "WebDriver version mismatch"

–û–±–Ω–æ–≤–∏—Ç–µ ChromeDriver:

```bash
pip install --upgrade chromedriver-binary
```

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã

- **IB API Solutions:** api-solutions@interactivebrokers.com
- **Selenium Docs:** https://www.selenium.dev/documentation/
- **WebDriver:** https://chromedriver.chromium.org/

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç

- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Selenium: `pip install selenium`
- [ ] –°–∫–∞—á–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å Gateway
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `IB_USE_SELENIUM=1`
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
- [ ] –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ API –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç

## üéâ –ì–æ—Ç–æ–≤–æ!

–¢–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç–µ —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ —Å Selenium, –∞ –∫–æ–≥–¥–∞ –ø–æ–ª—É—á–∏—Ç–µ credentials –æ—Ç IB - –ø—Ä–æ—Å—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `IB_OAUTH_CLIENT_ID` –∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å –Ω–∞ OAuth 2.0!

# Интеграция IBKR в калькулятор опционов

## Что реализовано

### Бэкенд

Создан новый роутер `/api/ibkr` с эндпоинтами:

1. **`GET /api/ibkr/stock-price?symbol=AAPL`**
   - Получение цены акции из IBKR
   - Возвращает: price, bid, ask, change, changePercent, volume, high, low

2. **`GET /api/ibkr/futures-contracts?symbol=ES`**
   - Получение списка доступных контрактов фьючерсов
   - Возвращает: массив контрактов с conId, symbol, description, localSymbol, expiry

3. **`GET /api/ibkr/futures-price?symbol=ES&contract=12345`**
   - Получение цены конкретного фьючерсного контракта
   - Возвращает: price, bid, ask, change, changePercent, volume

4. **`GET /api/ibkr/search?symbol=AAPL`**
   - Универсальный поиск инструментов

### Фронтенд

Блок "Тестовые данные" в калькуляторе опционов:

#### Функционал:
- **Выбор типа инструмента**: Акции или Фьючерсы
- **Ввод тикера**: Автоматический uppercase, подтверждение по Enter
- **Для акций**: Автоматическая загрузка цены после Enter
- **Для фьючерсов**: 
  1. После Enter загружаются доступные контракты
  2. Выбор контракта из списка
  3. Загрузка цены выбранного контракта

#### Правила работы:
1. **При смене типа инструмента** → сбрасывается input тикера и все данные
2. **При вводе тикера** → данные не загружаются до нажатия Enter
3. **После Enter** → тикер фиксируется и начинается загрузка данных

## Как использовать

### Для акций:
1. Выберите "Акции"
2. Введите тикер (например, AAPL)
3. Нажмите Enter
4. Цена загрузится автоматически

### Для фьючерсов:
1. Выберите "Фьючерсы"
2. Введите символ (например, ES, NQ, CL)
3. Нажмите Enter
4. Дождитесь загрузки контрактов
5. Выберите нужный контракт из списка
6. Цена загрузится автоматически

## Технические детали

### Состояния фронтенда:
- `selectedInstrumentType` - тип инструмента (stocks/futures)
- `tickerInput` - текущий ввод в поле тикера
- `confirmedTicker` - подтвержденный тикер (после Enter)
- `availableContracts` - список контрактов для фьючерсов
- `selectedContract` - выбранный контракт
- `instrumentPrice` - текущая цена
- `isLoadingContracts` - индикатор загрузки контрактов
- `isLoadingPrice` - индикатор загрузки цены

### Зависимости:
- Бэкенд использует `IBClient` из `app/services/ib_client.py`
- Требуется работающий IB Gateway на порту 5000
- SSH туннель должен быть открыт (см. `ANDREY_SETUP/!!!`)

## Возможные проблемы

### "Контракты не найдены"
- Проверьте правильность символа фьючерса
- Убедитесь что IB Gateway авторизован
- Проверьте SSH туннель

### "Цена не найдена"
- Убедитесь что IB Gateway авторизован
- Проверьте что рынок открыт
- Для фьючерсов: убедитесь что выбран контракт

### Ошибка 404 на эндпоинтах
- Убедитесь что бэкенд перезапущен после добавления нового роутера
- Проверьте что роутер подключен в `app/main.py`

## Файлы изменены

### Бэкенд:
- `backend/app/routers/ibkr_data.py` (создан)
- `backend/app/main.py` (добавлен импорт и подключение роутера)

### Фронтенд:
- `frontend/src/pages/OptionsCalculatorBasic.jsx` (обновлен блок "Тестовые данные")

#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è SSH —Ç—É–Ω–Ω–µ–ª—è –∫ prod TWS (–ê–Ω–¥—Ä–µ–π, clientId=102)

echo "üîå –ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ prod TWS —á–µ—Ä–µ–∑ SSH tunnel..."
echo "üì° –°–µ—Ä–≤–µ—Ä: 89.117.52.143"
echo "üîê –ö–ª—é—á: ~/.ssh/id_optioner"
echo "üö™ –ü–æ—Ä—Ç: 4002 -> 4002"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–æ—Ä—Ç –Ω–µ –∑–∞–Ω—è—Ç
if lsof -Pi :4002 -sTCP:LISTEN -t >/dev/null ; then
    echo "‚ö†Ô∏è  –ü–æ—Ä—Ç 4002 —É–∂–µ –∑–∞–Ω—è—Ç. –í–æ–∑–º–æ–∂–Ω–æ —Ç—É–Ω–Ω–µ–ª—å —É–∂–µ –æ—Ç–∫—Ä—ã—Ç."
    echo "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å: lsof -i :4002"
    echo "–£–±–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å: pkill -f 'ssh.*4002'"
    exit 1
fi

# –û—Ç–∫—Ä—ã—Ç—å —Ç—É–Ω–Ω–µ–ª—å
ssh -i ~/.ssh/id_optioner \
    -L 4002:127.0.0.1:4002 \
    -N \
    root@89.117.52.143 &

SSH_PID=$!

sleep 2

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ç—É–Ω–Ω–µ–ª—å –æ—Ç–∫—Ä—ã–ª—Å—è
if lsof -Pi :4002 -sTCP:LISTEN -t >/dev/null ; then
    echo "‚úÖ –¢—É–Ω–Ω–µ–ª—å —É—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä—ã—Ç (PID: $SSH_PID)"
    echo "‚úÖ TWS API –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ localhost:4002"
    echo ""
    echo "–¢–µ–ø–µ—Ä—å –º–æ–∂–µ—à—å:"
    echo "  ‚Ä¢ –ó–∞–ø—É—Å–∫–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–∫—Ä–∏–ø—Ç—ã —Å ib_insync"
    echo "  ‚Ä¢ –†–∞–±–æ—Ç–∞—Ç—å –≤ Jupyter notebooks"
    echo "  ‚Ä¢ –ü–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –∫ TWS —Å clientId=102"
    echo ""
    echo "–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç—É–Ω–Ω–µ–ª—è:"
    echo "  pkill -f 'ssh.*4002'"
    echo "  –∏–ª–∏: kill $SSH_PID"
else
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ç—É–Ω–Ω–µ–ª—å"
    echo "–ü—Ä–æ–≤–µ—Ä—å:"
    echo "  1. –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞ (ping 89.117.52.143)"
    echo "  2. SSH –∫–ª—é—á (~/.ssh/id_optioner)"
    echo "  3. –ü—Ä–∞–≤–∞ –Ω–∞ –∫–ª—é—á (chmod 600 ~/.ssh/id_optioner)"
    exit 1
fi

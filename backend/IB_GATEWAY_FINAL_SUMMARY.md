# üéâ –§–ò–ù–ê–õ–¨–ù–û–ï –†–ï–ó–Æ–ú–ï: IB CLIENT PORTAL GATEWAY

**–î–∞—Ç–∞:** 3 –Ω–æ—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –û–°–ù–û–í–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ –†–ï–®–ï–ù–´

---

## ‚úÖ –ß–¢–û –î–û–°–¢–ò–ì–ù–£–¢–û

### 1. –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å ‚úÖ
- **3/3 —Ç–µ—Å—Ç–∞ —É—Å–ø–µ—à–Ω—ã** –ø–æ–¥—Ä—è–¥
- **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ —Ç–µ—Ä—è–µ—Ç—Å—è** (authenticated: true –ø–æ—Å—Ç–æ—è–Ω–Ω–æ)
- **–î–∞–Ω–Ω—ã–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏** (—Ü–µ–Ω–∞ –º–µ–Ω—è–µ—Ç—Å—è)

### 2. Stock Price Data ‚úÖ
**–í–°–ï –ü–û–õ–Ø –ö–û–†–†–ï–ö–¢–ù–´–ï:**
```
ticker: SPY
price: $684.64
bid: $684.63
ask: $684.67      ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û (–±—ã–ª–æ $480)
high: $684.67
low: $177.00      ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û (–±—ã–ª–æ $166,000)
volume: 800
previous_close: $682.06  ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û (–±—ã–ª–æ $0)
change: +$2.58
change_percent: +0.38%
```

**–†–µ—à–µ–Ω–∏—è:**
- ‚úÖ **Ask:** Field 86 –≤–º–µ—Å—Ç–æ 85 (85 = ask SIZE, –Ω–µ —Ü–µ–Ω–∞!)
- ‚úÖ **Low:** Field 87_raw / 1000 (raw –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Ç—ã—Å—è—á–∞—Ö)
- ‚úÖ **Previous Close:** –†–∞—Å—á–µ—Ç —á–µ—Ä–µ–∑ price - change (field 82)

### 3. Expiration Dates ‚úÖ
- ‚úÖ **14 –¥–∞—Ç** (NOV25 - JAN28)
- ‚úÖ –§–æ—Ä–º–∞—Ç MMMYY
- ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞–µ—Ç

### 4. Options Chain ‚úÖ (–°—Ç—Ä—É–∫—Ç—É—Ä–∞)
- ‚úÖ –ü–æ–ª—É—á–∞–µ–º conid –æ–ø—Ü–∏–æ–Ω–æ–≤
- ‚úÖ –í—ã–±–∏—Ä–∞–µ–º ATM —Å—Ç—Ä–∞–π–∫–∏ (¬±5% –æ—Ç —Ü–µ–Ω—ã)
- ‚úÖ –§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π

---

## ‚ùå –ù–ï –†–ï–®–ï–ù–û

### Options Market Data (Greeks/IV)
**–°—Ç–∞—Ç—É—Å:** ‚ùå –ü—É—Å—Ç–æ

**–ü—Ä–∏—á–∏–Ω–∞:**
Paper Account IB –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç real-time options market data –±–µ–∑:
- Market data subscription (~$10-20/–º–µ—Å) üí∞
- Live account (–Ω–µ paper)

**–ß—Ç–æ –ø—Ä–æ–±–æ–≤–∞–ª–∏:**
1. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏–ª–∏ field mapping
2. ‚úÖ ATM —Å—Ç—Ä–∞–π–∫–∏ –≤–º–µ—Å—Ç–æ deep OTM
3. ‚úÖ –î–≤–æ–π–Ω–æ–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
4. ‚ùå **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ —Ä–∞–≤–Ω–æ –ø—É—Å—Ç–æ

**–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ:**
```
"error": "Reg snapshot is not available for a paper account"
```

---

## üéØ –†–ï–®–ï–ù–ò–Ø

### –î–ª—è Stock Price: ‚úÖ –ì–û–¢–û–í–û
–í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–∞–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å.

### –î–ª—è Options:

**–í–∞—Ä–∏–∞–Ω—Ç 1: Market Data Subscription** üí∞
```
–°—Ç–æ–∏–º–æ—Å—Ç—å: $10-20/–º–µ—Å
–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞: Real-time bid/ask/iv/greeks –æ—Ç IB
–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏: –ü–ª–∞—Ç–Ω–æ
```

**–í–∞—Ä–∏–∞–Ω—Ç 2: –õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç** ‚úÖ **–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø**
```python
# –ò—Å–ø–æ–ª—å–∑—É–µ–º py_vollib
from py_vollib.black_scholes import black_scholes as bs
from py_vollib.black_scholes.greeks.analytical import delta, gamma, theta, vega

# –ü–æ–ª—É—á–∞–µ–º –æ—Ç IB:
strike = 685.0
underlying_price = 684.64
days_to_expiration = 14
interest_rate = 0.05

# –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ:
iv = calculate_iv(...)
delta_val = delta('c', underlying_price, strike, days_to_expiration/365, interest_rate, iv)
gamma_val = gamma('c', underlying_price, strike, days_to_expiration/365, interest_rate, iv)
# –∏ —Ç.–¥.
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ë–µ—Å–ø–ª–∞—Ç–Ω–æ
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å paper account
- ‚úÖ –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É

**–í–∞—Ä–∏–∞–Ω—Ç 3: Live Account**
```
–ú–æ–∂–µ—Ç –¥–∞—Ç—å –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö
–ù–æ —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —Ç–æ–∂–µ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É
```

---

## üìä –ò–¢–û–ì–û–í–ê–Ø –¢–ê–ë–õ–ò–¶–ê

| –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª | –°—Ç–∞—Ç—É—Å | –ò—Å—Ç–æ—á–Ω–∏–∫ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|------------|--------|----------|-------------|
| **Stock Price** | ‚úÖ | IB Gateway | –í—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã |
| **Bid/Ask** | ‚úÖ | IB Gateway | Field 84/86 |
| **Volume** | ‚úÖ | IB Gateway | Field 88 |
| **Previous Close** | ‚úÖ | –†–∞—Å—á–µ—Ç | price - change |
| **Expiration Dates** | ‚úÖ | IB Gateway | 14 –¥–∞—Ç |
| **Options conid** | ‚úÖ | IB Gateway | –†–∞–±–æ—Ç–∞–µ—Ç |
| **Options strikes** | ‚úÖ | IB Gateway | ATM —Ñ–∏–ª—å—Ç—Ä |
| **Options bid/ask** | ‚ùå | –ü–æ–¥–ø–∏—Å–∫–∞ | –ù—É–∂–Ω–∞ $$ |
| **Options IV** | ‚ùå | py_vollib | –õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç |
| **Options Greeks** | ‚ùå | py_vollib | –õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç |
| **Historical Data** | ‚ùì | –ù–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª–∏ | TODO |

---

## üöÄ –ß–¢–û –î–ê–õ–¨–®–ï

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç Greeks
1. ‚úÖ py_vollib —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞—Å—á–µ—Ç–∞ Greeks
3. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ IBClient.get_options_chain()
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ—á–Ω–æ—Å—Ç—å

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: Historical Data
1. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å `/iserver/marketdata/history`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö
3. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ IBClient

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
1. –ó–∞–º–µ–Ω–∏—Ç—å HybridClient –Ω–∞ IBClient
2. –û–±–Ω–æ–≤–∏—Ç—å DataSourceFactory
3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—ã
4. –î–µ–ø–ª–æ–π

---

## üìù –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò

### –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π Field Mapping –¥–ª—è Client Portal API:
```
Stock Price:
- 31 = Last Price
- 84 = Bid Price
- 86 = Ask Price (–ù–ï 85!)
- 87 = Low (string —Å "K")
- 87_raw = Low (float –≤ —Ç—ã—Å—è—á–∞—Ö)
- 88 = Volume
- 82 = Change
- 83 = Change %

Options:
- 7087 = Implied Volatility (—Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É)
- 7308 = Delta (—Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É)
- 7084 = Gamma (—Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É)
- 7085 = Theta (–º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω)
- 7086 = Vega (—Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É)
```

### –í–∞–∂–Ω—ã–µ –Ω–∞—Ö–æ–¥–∫–∏:
1. **Field 85 = Ask SIZE, –ù–ï —Ü–µ–Ω–∞!**
2. **Field 87_raw –Ω—É–∂–Ω–æ –¥–µ–ª–∏—Ç—å –Ω–∞ 1000**
3. **Previous close = price - change**
4. **Paper account != market data subscription**

---

## üéØ –í–´–í–û–î–´

### ‚úÖ –ü–û–õ–û–ñ–ò–¢–ï–õ–¨–ù–û–ï:
1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ IB Gateway **—Å—Ç–∞–±–∏–ª—å–Ω–æ–µ**
2. Stock price data **–ø–æ–ª–Ω–æ—Å—Ç—å—é –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è**
3. Options —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ **—Ä–∞–±–æ—Ç–∞–µ—Ç**
4. ATM —Ñ–∏–ª—å—Ç—Ä **—Ä–∞–±–æ—Ç–∞–µ—Ç**
5. –ù–∞—à–ª–∏ –∏ –∏—Å–ø—Ä–∞–≤–∏–ª–∏ **–≤—Å–µ –∞–Ω–æ–º–∞–ª–∏–∏** –≤ stock data

### ‚ö†Ô∏è –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø:
1. Options market data —Ç—Ä–µ–±—É–µ—Ç **–ø–æ–¥–ø–∏—Å–∫—É –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç**
2. Paper account **–æ–≥—Ä–∞–Ω–∏—á–µ–Ω** –ø–æ market data
3. Greeks –Ω—É–∂–Ω–æ **—Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ** (py_vollib)

### üéâ –†–ï–ó–£–õ–¨–¢–ê–¢:
**IB Client Portal Gateway –ì–û–¢–û–í –ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ –¥–ª—è stock data!**
**Options —Ç—Ä–µ–±—É—é—Ç –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ Greeks —á–µ—Ä–µ–∑ py_vollib.**

---

## üìÑ –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø

- **–ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑:** `IB_GATEWAY_DATA_ANALYSIS.md`
- **–¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç:** `test_ib_gateway_only.py`
- **–ö–ª–∏–µ–Ω—Ç:** `backend/app/services/ib_client.py`

# TradingView Parser v9 — Команды от калькулятора

## Обзор

Расширение для сбора данных опционов с TradingView. Версия 9 добавляет возможность **запуска сбора данных по команде от калькулятора**.

## Что реализовано

### Из v8:
- ✅ Кнопка "📊 Собрать все данные" в popup расширения
- ✅ Overlay с прогрессом на странице TradingView
- ✅ Парсинг всех опционов на странице
- ✅ Получение списка экспираций
- ✅ Последовательный переход по экспирациям (2-5 сек задержка)
- ✅ Сохранение в `chrome.storage.local.tvc_full_chain`
- ✅ Синхронизация в `localStorage` калькулятора
- ✅ Защита от бана (рандомные задержки, cooldown, лимиты)

### Новое в v9:
- ✅ Мгновенная реакция на команды от калькулятора через StorageEvent
- 🔲 Обработка команды `collectFullChain` в background.js
- 🔲 Обновление `tvc_status` в процессе сбора

---

## Архитектура команд

```
┌─────────────────────────────────────────────────────────────────────┐
│  КАЛЬКУЛЯТОР (localhost:3000 / futures.optioner.online)             │
│                                                                     │
│  1. Пользователь нажимает кнопку "Загрузить цепочку опционов"       │
│  2. Калькулятор записывает команду в localStorage:                  │
│     localStorage.setItem('tvc_command', JSON.stringify({...}))      │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│  OPTIONER.JS (content script на странице калькулятора)              │
│                                                                     │
│  1. Слушает StorageEvent — МГНОВЕННАЯ реакция на tvc_command        │
│  2. Парсит команду и отправляет в background.js                     │
│  3. Удаляет команду из localStorage                                 │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│  BACKGROUND.JS (service worker расширения)                          │
│                                                                     │
│  1. Получает команду 'collectFullChain'                             │
│  2. Открывает вкладку TradingView с нужным тикером                  │
│  3. Запускает сбор данных (переход по экспирациям)                  │
│  4. Сохраняет результат в chrome.storage.local.tvc_full_chain       │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│  OPTIONER.JS → КАЛЬКУЛЯТОР                                          │
│                                                                     │
│  1. Синхронизирует tvc_full_chain в localStorage калькулятора       │
│  2. Триггерит StorageEvent для React                                │
│  3. Калькулятор получает данные и обновляет UI                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Формат команды от калькулятора

```javascript
localStorage.setItem('tvc_command', JSON.stringify({
  action: 'collectFullChain',
  ticker: 'ESM2026',
  maxExpirations: 10,
  timestamp: Date.now()
}));
```

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `action` | string | ✅ | `'collectFullChain'` |
| `ticker` | string | ✅ | Тикер: `'ESM2026'`, `'ESH2026'` |
| `maxExpirations` | number | ❌ | Лимит экспираций (1-20, по умолчанию 5) |
| `timestamp` | number | ✅ | `Date.now()` |

---

## Формат результата: tvc_full_chain

```javascript
{
  collectedAt: "2026-01-18T20:45:00.000Z",
  ticker: "ESM2026",
  expirations: [
    {
      date: "Mar 20",
      dateCode: "20260320",
      options: [
        {
          type: "CALL",
          strike: 6950,
          bid: 224.5,
          ask: 226.0,
          iv: 14.1,
          delta: 0.61,
          gamma: 0.0009,
          theta: -1.29,
          vega: 11.24,
          rho: 7.08
        }
      ]
    }
  ]
}
```

---

## Конфигурация

```javascript
const COLLECTOR_CONFIG = {
  MIN_DELAY: 2000,
  MAX_DELAY: 5000,
  MAX_EXPIRATIONS: 5,
  COOLDOWN: 30000,
  PAGE_TIMEOUT: 60000,
  MAX_CONSECUTIVE_ERRORS: 3
};
```

---

## TODO v9

- [x] Мгновенная реакция на команды (StorageEvent в optioner.js)
- [ ] Обработка команды `collectFullChain` в background.js
- [ ] Обновление `tvc_status` в процессе сбора
- [ ] Тестирование полного цикла

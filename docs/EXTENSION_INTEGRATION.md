# Интеграция с Chrome Extension для TradingView

## Описание функционала

В табе "Сделка" калькулятора опционов реализован функционал отправки срезок плана выхода на график TradingView через Chrome Extension.

### Основные возможности:
1. **Отправка срезок на график** - пользователь может отправить план выхода (шаги продажи опционов) на график TradingView
2. **Переход на график** - после отправки срезок пользователь может перейти на график TradingView в новой вкладке
3. **Сброс плана выхода** - пользователь может удалить ранее отправленные срезки из расширения

---

## Механизм взаимодействия

Взаимодействие происходит через `localStorage`:
- **Ключ для команд**: `tvc_refresh_command`
- **Ключ для результатов**: `tvc_refresh_result`

Веб-приложение записывает команду в `localStorage`, расширение читает её, выполняет и записывает результат обратно.

---

## Команды от веб-приложения

### 1. Команда `send_slices_to_chart`

**Когда отправляется**: При нажатии кнопки "Отправить срезки на график TradingView →"

**Формат команды**:
```json
{
  "type": "send_slices_to_chart",
  "slices": [
    {
      "price": 6.85,
      "text": "Срезка 1 - цена Акции 269.48 - цена Опциона 6.85 * 5 - дата входа 03.02.26"
    },
    {
      "price": 8.20,
      "text": "Срезка 2 - цена Акции 269.48 - цена Опциона 8.20 * 4 - дата входа 03.02.26"
    },
    {
      "price": 9.55,
      "text": "Срезка 3 - цена Акции 269.48 - цена Опциона 9.55 * 3 - дата входа 03.02.26"
    },
    {
      "price": 10.90,
      "text": "Срезка 4 - цена Акции 269.48 - цена Опциона 10.90 * 2 - дата входа 03.02.26"
    }
  ],
  "chartUrl": "https://www.tradingview.com/chart/?symbol=OPRA:MSFT260220C430.0",
  "timestamp": 1738672800000,
  "processed": false
}
```

**Описание полей**:
- `type` - тип команды (всегда `"send_slices_to_chart"`)
- `slices` - массив срезок плана выхода
  - `price` - цена опциона для данной срезки (number)
  - `text` - текст для отображения на графике (string)
- `chartUrl` - ссылка на график опциона на TradingView (string)
- `timestamp` - время создания команды в миллисекундах (number)
- `processed` - флаг обработки (boolean, всегда `false` при отправке)

**Что должно сделать расширение**:
1. Прочитать команду из `localStorage` по ключу `tvc_refresh_command`
2. Открыть график по ссылке `chartUrl` (если требуется)
3. Разместить на графике TradingView горизонтальные линии для каждой срезки:
   - На уровне цены `price`
   - С текстом `text`
   - Добавить на эту горизонтальную линию стандартный алерт
4. Записать результат выполнения в `localStorage` по ключу `tvc_refresh_result`

---

### 2. Команда `clear_slices`

**Когда отправляется**: При нажатии кнопки "Сбросить план выхода"

**Формат команды**:
```json
{
  "type": "clear_slices",
  "chartUrl": "https://www.tradingview.com/chart/?symbol=OPRA:MSFT260220C430.0",
  "timestamp": 1738672900000,
  "processed": false
}
```

**Описание полей**:
- `type` - тип команды (всегда `"clear_slices"`)
- `chartUrl` - ссылка на график опциона на TradingView (string)
- `timestamp` - время создания команды в миллисекундах (number)
- `processed` - флаг обработки (boolean, всегда `false` при отправке)

**Что должно сделать расширение**:
1. Прочитать команду из `localStorage` по ключу `tvc_refresh_command`
2. Определить график по ссылке `chartUrl`
3. Удалить все ранее размещенные срезки с указанного графика TradingView
4. Записать результат выполнения в `localStorage` по ключу `tvc_refresh_result`

---

## Ожидаемый ответ от расширения

После выполнения любой команды расширение должно записать результат в `localStorage` по ключу `tvc_refresh_result`.

**Формат ответа**:
```json
{
  "status": "success",
  "message": "Команда выполнена успешно",
  "timestamp": 1738672850000
}
```

**Описание полей**:
- `status` - статус выполнения команды
  - `"success"` - команда выполнена успешно
  - `"error"` - произошла ошибка при выполнении
- `message` - текстовое описание результата (string)
- `timestamp` - время выполнения команды в миллисекундах (number)

**В случае ошибки**:
```json
{
  "status": "error",
  "message": "Описание ошибки",
  "timestamp": 1738672850000
}
```

---

## Формат ссылки на график TradingView

Ссылка формируется по шаблону:
```
https://www.tradingview.com/chart/?symbol=OPRA:{TICKER}{YYMMDD}{TYPE}{STRIKE}
```

**Пример**: `https://www.tradingview.com/chart/?symbol=OPRA:MSFT260220C430.0`

Где:
- `MSFT` - тикер базового актива
- `260220` - дата экспирации (20 февраля 2026 года в формате YYMMDD)
- `C` - тип опциона (C для CALL, P для PUT)
- `430.0` - страйк (если целое число, обязательно добавляется `.0`)

---

## Примечания

1. Веб-приложение **не ожидает** получения дополнительных данных от расширения, кроме подтверждения выполнения команды
2. Расширение должно установить флаг `processed: true` в команде после её обработки (опционально)
3. Все команды содержат поле `timestamp` для отслеживания порядка выполнения
4. Веб-приложение логирует все отправляемые команды в консоль браузера для отладки

---

## Контакты для вопросов

При возникновении вопросов по интеграции обращайтесь к команде разработки веб-приложения.
